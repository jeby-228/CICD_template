# ABP å°ˆæ¡ˆ CodeQL å®‰å…¨æƒæï¼ˆåƒ… JavaScript/TypeScriptï¼‰
# é©ç”¨æ–¼å°šæœªæœ‰ C# ç¨‹å¼ç¢¼çš„æ¨¡æ¿å°ˆæ¡ˆ
#
name: 'CodeQL å®‰å…¨æƒæï¼ˆJS/TSï¼‰'

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  schedule:
    - cron: '0 2 * * 1' # æ¯é€±ä¸€å‡Œæ™¨ 2 é»åŸ·è¡Œï¼ˆå°åŒ—æ™‚é–“ï¼‰

jobs:
  analyze:
    name: JavaScript/TypeScript å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: å–å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      # è¨­å®š Node.js ç’°å¢ƒ
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # æª¢æŸ¥æ˜¯å¦æœ‰ JS/TS æª”æ¡ˆ
      - name: æª¢æŸ¥ JavaScript/TypeScript æª”æ¡ˆ
        id: check-js
        run: |
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "package.json" | head -1 | grep -q .; then
            echo "has-js-files=true" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ° JavaScript/TypeScript æª”æ¡ˆ"
          else
            echo "has-js-files=false" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° JavaScript/TypeScript æª”æ¡ˆï¼Œè·³éæƒæ"
          fi

      # åˆå§‹åŒ– CodeQL
      - name: åˆå§‹åŒ– CodeQL
        if: steps.check-js.outputs.has-js-files == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality

      # åŸ·è¡Œ CodeQL åˆ†æ
      - name: åŸ·è¡Œ CodeQL åˆ†æ
        if: steps.check-js.outputs.has-js-files == 'true'
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:javascript-typescript'
          output: sarif-results
          upload: false

      # ä¸Šå‚³ SARIF æª”æ¡ˆåˆ° GitHub Security
      - name: ä¸Šå‚³ SARIF åˆ° GitHub Security
        if: steps.check-js.outputs.has-js-files == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: sarif-results/javascript-typescript.sarif
        continue-on-error: true

      # ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
      - name: ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
        if: steps.check-js.outputs.has-js-files == 'true'
        run: |
          echo "## ğŸ” CodeQL JavaScript/TypeScript å®‰å…¨æƒæçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "sarif-results/javascript-typescript.sarif" ]; then
            # è§£æ SARIF æª”æ¡ˆä¸¦è¨ˆç®—æ¼æ´æ•¸é‡
            CRITICAL=$(jq '[.runs[].results[] | select(.level=="error")] | length' sarif-results/javascript-typescript.sarif)
            HIGH=$(jq '[.runs[].results[] | select(.level=="warning")] | length' sarif-results/javascript-typescript.sarif)
            MEDIUM=$(jq '[.runs[].results[] | select(.level=="note")] | length' sarif-results/javascript-typescript.sarif)
            TOTAL=$(jq '[.runs[].results[]] | length' sarif-results/javascript-typescript.sarif)
            
            echo "### ğŸ“Š æ¼æ´çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| åš´é‡ç¨‹åº¦ | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ Critical/Error | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ  High/Warning | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ Medium/Note | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| **ç¸½è¨ˆ** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$TOTAL" -eq 0 ]; then
              echo "âœ… **æœªç™¼ç¾å®‰å…¨æ¼æ´**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **ç™¼ç¾ $TOTAL å€‹æ½›åœ¨å•é¡Œï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Š**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° SARIF å ±å‘Šæª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      # ä¸Šå‚³ SARIF å ±å‘Šç‚º artifact
      - name: ä¸Šå‚³æ¼æ´å ±å‘Š Artifact
        if: steps.check-js.outputs.has-js-files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codeql-js-vulnerability-report
          path: sarif-results/
          retention-days: 90
        continue-on-error: true
