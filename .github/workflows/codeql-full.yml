# ABP å°ˆæ¡ˆ CodeQL å®‰å…¨æƒæ
# è‡ªå‹•åµæ¸¬ç¨‹å¼ç¢¼ä¸­çš„å®‰å…¨æ¼æ´å’Œç¨‹å¼ç¢¼å“è³ªå•é¡Œ
#
name: 'ABP CodeQL å®‰å…¨æƒæ'

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  schedule:
    - cron: '0 2 * * 1' # æ¯é€±ä¸€å‡Œæ™¨ 2 é»åŸ·è¡Œï¼ˆå°åŒ—æ™‚é–“ï¼‰

jobs:
  analyze:
    name: åˆ†æ (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # ABP å°ˆæ¡ˆä¸»è¦ä½¿ç”¨ C# å’Œ JavaScript/TypeScript
          - language: csharp
            build-mode: manual
          - language: javascript-typescript
            build-mode: none
    steps:
      - name: å–å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      # è¨­å®š .NET ç’°å¢ƒï¼ˆABP éœ€è¦ï¼‰
      - name: è¨­å®š .NET
        if: matrix.language == 'csharp'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # è¨­å®š Node.js ç’°å¢ƒï¼ˆå‰ç«¯è³‡æºéœ€è¦ï¼‰
      - name: è¨­å®š Node.js
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # åˆå§‹åŒ– CodeQL æƒæå·¥å…·
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          # ä½¿ç”¨å®‰å…¨æ€§å’Œå“è³ªæŸ¥è©¢é›†åˆ
          queries: security-and-quality

      # æª¢æŸ¥æ˜¯å¦æœ‰ C# å°ˆæ¡ˆæª”æ¡ˆ
      - name: æª¢æŸ¥ C# å°ˆæ¡ˆ
        if: matrix.language == 'csharp'
        id: check-csharp
        run: |
          if find . -name "*.csproj" -o -name "*.sln" | head -1 | grep -q .; then
            echo "has-csharp-files=true" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ° C# å°ˆæ¡ˆæª”æ¡ˆ"
          else
            echo "has-csharp-files=false" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° C# å°ˆæ¡ˆæª”æ¡ˆï¼Œè·³é C# æƒæ"
          fi

      # æ‰‹å‹•å»ºæ§‹æ­¥é©Ÿï¼ˆåƒ…ç•¶æœ‰ C# æª”æ¡ˆæ™‚ï¼‰
      - name: åŸ·è¡Œæ‰‹å‹•å»ºæ§‹
        if: matrix.build-mode == 'manual' && steps.check-csharp.outputs.has-csharp-files == 'true'
        run: |
          echo "åŸ·è¡Œ ABP å°ˆæ¡ˆå»ºæ§‹"
          dotnet restore
          dotnet build --no-restore

      # åŸ·è¡Œ CodeQL åˆ†æ
      - name: åŸ·è¡Œ CodeQL åˆ†æ
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:${{matrix.language}}'
          output: sarif-results
          upload: false

      # ä¸Šå‚³ SARIF æª”æ¡ˆåˆ° GitHub Security
      - name: ä¸Šå‚³ SARIF åˆ° GitHub Security
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: sarif-results/${{matrix.language}}.sarif
        continue-on-error: true

      # ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
      - name: ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        run: |
          echo "## ğŸ” CodeQL ${{ matrix.language }} å®‰å…¨æƒæçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "sarif-results/${{matrix.language}}.sarif" ]; then
            # è§£æ SARIF æª”æ¡ˆä¸¦è¨ˆç®—æ¼æ´æ•¸é‡
            CRITICAL=$(jq '[.runs[].results[] | select(.level=="error")] | length' sarif-results/${{matrix.language}}.sarif)
            HIGH=$(jq '[.runs[].results[] | select(.level=="warning")] | length' sarif-results/${{matrix.language}}.sarif)
            MEDIUM=$(jq '[.runs[].results[] | select(.level=="note")] | length' sarif-results/${{matrix.language}}.sarif)
            TOTAL=$(jq '[.runs[].results[]] | length' sarif-results/${{matrix.language}}.sarif)
            
            echo "### ğŸ“Š æ¼æ´çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| åš´é‡ç¨‹åº¦ | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ Critical/Error | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ  High/Warning | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ Medium/Note | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| **ç¸½è¨ˆ** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$TOTAL" -eq 0 ]; then
              echo "âœ… **æœªç™¼ç¾å®‰å…¨æ¼æ´**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **ç™¼ç¾ $TOTAL å€‹æ½›åœ¨å•é¡Œï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Š**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ”— æŸ¥çœ‹è©³ç´°å ±å‘Š" >> $GITHUB_STEP_SUMMARY
              echo "- å‰å¾€ [Security > Code scanning alerts](../security/code-scanning) æŸ¥çœ‹å®Œæ•´æ¼æ´åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
              echo "- ä¸‹è¼‰æœ¬æ¬¡æƒæçš„ SARIF å ±å‘Šæª”æ¡ˆå¾ Artifacts" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° SARIF å ±å‘Šæª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      # ä¸Šå‚³ SARIF å ±å‘Šç‚º artifact
      - name: ä¸Šå‚³æ¼æ´å ±å‘Š Artifact
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: actions/upload-artifact@v4
        with:
          name: codeql-${{matrix.language}}-vulnerability-report
          path: sarif-results/
          retention-days: 90
        continue-on-error: true
