# Pull Request è‡ªå‹•åŒ–æª¢æŸ¥å’Œå¯©æŸ¥å·¥ä½œæµç¨‹
# ç•¶å»ºç«‹æˆ–æ›´æ–° PR æ™‚è‡ªå‹•åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
name: PR Review & Quality Check

# è§¸ç™¼æ¢ä»¶ - é‡å°æ‰€æœ‰åˆ†æ”¯çš„ Pull Request
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'

# å…¨åŸŸç’°å¢ƒè®Šæ•¸
env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  SOLUTION_PATH: 'PortalApi.sln'

# ä½µç™¼æ§åˆ¶ - å–æ¶ˆåŒä¸€ PR çš„èˆŠç‰ˆåŸ·è¡Œ
concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # === ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ===
  code-quality:
    name: 'ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥'
    runs-on: windows-latest
    # è·³éè‰ç¨¿ PR é™¤éæ˜ç¢ºæ¨™è¨˜
    if: github.event.pull_request.draft == false

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡º PR ç¨‹å¼ç¢¼
      - name: Checkout PR code
        uses: actions/checkout@v5
        with:
          # æª¢å‡º PR çš„ HEADï¼ŒåŒ…å«å®Œæ•´æ­·å²è¨˜éŒ„ç”¨æ–¼æ¯”è¼ƒ
          fetch-depth: 0

      # æ­¥é©Ÿ 2: è¨­å®š .NET ç’°å¢ƒ
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # æ­¥é©Ÿ 3: å¿«å– NuGet å¥—ä»¶
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # æ­¥é©Ÿ 4: é‚„åŸ NuGet ç›¸ä¾æ€§
      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}
        shell: powershell

      # æ­¥é©Ÿ 5: å»ºç½®å°ˆæ¡ˆ
      - name: Build solution
        run: |
          Write-Host "=== å»ºç½®æ–¹æ¡ˆ ===" -ForegroundColor Green
          dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
        shell: powershell

      # æ­¥é©Ÿ 6: æª¢æŸ¥ NuGet å¥—ä»¶æˆæ¬Š
      - name: Check NuGet package licenses
        uses: jwaliszko/nuget-license-sentinel@v1
        with:
          solution-path: ${{ env.SOLUTION_PATH }}
          allowed-licenses: 'MIT,Apache-2.0,BSD-3-Clause,ISC,BSD-2-Clause,MS-PL,CC0-1.0'
          fail-on-forbidden: true
          output-file: 'license-report.json'
          include-project-dependencies: true

  # === å®‰å…¨æ€§æƒæï¼ˆCodeQLï¼‰===
  security-scan:
    name: 'å®‰å…¨æ€§æƒæ'
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      security-events: write
      contents: read
      actions: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: csharp
            build-mode: manual
          - language: javascript-typescript
            build-mode: none

    steps:
      - name: å–å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      # è¨­å®š .NET ç’°å¢ƒï¼ˆC# éœ€è¦ï¼‰
      - name: è¨­å®š .NET
        if: matrix.language == 'csharp'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # è¨­å®š Node.js ç’°å¢ƒï¼ˆå‰ç«¯éœ€è¦ï¼‰
      - name: è¨­å®š Node.js
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # åˆå§‹åŒ– CodeQL
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: security-and-quality

      # æª¢æŸ¥æ˜¯å¦æœ‰ C# å°ˆæ¡ˆæª”æ¡ˆ
      - name: æª¢æŸ¥ C# å°ˆæ¡ˆ
        if: matrix.language == 'csharp'
        id: check-csharp
        run: |
          if find . -name "*.csproj" -o -name "*.sln" | head -1 | grep -q .; then
            echo "has-csharp-files=true" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ° C# å°ˆæ¡ˆæª”æ¡ˆ"
          else
            echo "has-csharp-files=false" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° C# å°ˆæ¡ˆæª”æ¡ˆï¼Œè·³é C# æƒæ"
          fi

      # æ‰‹å‹•å»ºæ§‹æ­¥é©Ÿï¼ˆåƒ…ç•¶æœ‰ C# æª”æ¡ˆæ™‚ï¼‰
      - name: åŸ·è¡Œæ‰‹å‹•å»ºæ§‹
        if: matrix.build-mode == 'manual' && steps.check-csharp.outputs.has-csharp-files == 'true'
        run: |
          echo "åŸ·è¡Œ ABP å°ˆæ¡ˆå»ºæ§‹"
          dotnet restore
          dotnet build --no-restore

      # åŸ·è¡Œ CodeQL åˆ†æ
      - name: åŸ·è¡Œ CodeQL åˆ†æ
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:${{matrix.language}}'
          output: sarif-results
          upload: false

      # ä¸Šå‚³ SARIF åˆ° GitHub Security
      - name: ä¸Šå‚³ SARIF åˆ° GitHub Security
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: sarif-results/${{matrix.language}}.sarif
        continue-on-error: true

      # ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
      - name: ç”Ÿæˆæ¼æ´å ±å‘Šæ‘˜è¦
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        run: |
          echo "## ğŸ” CodeQL ${{ matrix.language }} æƒæçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "sarif-results/${{matrix.language}}.sarif" ]; then
            CRITICAL=$(jq '[.runs[].results[] | select(.level=="error")] | length' sarif-results/${{matrix.language}}.sarif)
            HIGH=$(jq '[.runs[].results[] | select(.level=="warning")] | length' sarif-results/${{matrix.language}}.sarif)
            MEDIUM=$(jq '[.runs[].results[] | select(.level=="note")] | length' sarif-results/${{matrix.language}}.sarif)
            TOTAL=$(jq '[.runs[].results[]] | length' sarif-results/${{matrix.language}}.sarif)
            
            echo "| åš´é‡ç¨‹åº¦ | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ Critical/Error | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ  High/Warning | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ Medium/Note | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| **ç¸½è¨ˆ** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            
            # å„²å­˜çµæœä¾›å¾ŒçºŒä½¿ç”¨
            echo "CODEQL_${matrix.language//-/_}_TOTAL=$TOTAL" >> $GITHUB_ENV
            echo "CODEQL_${matrix.language//-/_}_CRITICAL=$CRITICAL" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # ä¸Šå‚³ SARIF å ±å‘Š
      - name: ä¸Šå‚³æ¼æ´å ±å‘Š Artifact
        if: |
          (matrix.language == 'csharp' && steps.check-csharp.outputs.has-csharp-files == 'true') ||
          (matrix.language == 'javascript-typescript')
        uses: actions/upload-artifact@v4
        with:
          name: codeql-${{matrix.language}}-report
          path: sarif-results/
          retention-days: 90
        continue-on-error: true


  # === PR ç‹€æ…‹å’Œè©•è«– ===
  pr-feedback:
    name: 'PR å›é¥‹'
    permissions:
      issues: write # ç™¼å¸ƒç•™è¨€åˆ° PR
      contents: read # è®€å–ç¨‹å¼ç¢¼
      pull-requests: write # å¯«å…¥ PR
      actions: read # è®€å– Actions

    runs-on: windows-latest
    needs: [code-quality, security-scan]
    if: always() && github.event.pull_request.draft == false

    steps:
      # æª¢å‡ºç¨‹å¼ç¢¼ä»¥ä½¿ç”¨æœ¬åœ° action
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: codeql-*-report
          path: security-reports
          merge-multiple: true
        continue-on-error: true

      - name: Generate PR comment
        uses: actions/github-script@v8
        with:
          script: |

            const codeQualityResult = process.env.CODE_QUALITY_RESULT ?? '${{ needs.code-quality.result }}';
            const securityScanResult = process.env.SECURITY_SCAN_RESULT ?? '${{ needs.security-scan.result }}';
            
            let cqStatus = codeQualityResult;
            let secStatus = securityScanResult;

            // å»ºç«‹ç‹€æ…‹å ±å‘Š
            let comment = `## ğŸ” PR è‡ªå‹•æª¢æŸ¥å ±å‘Š\n\n`;
            comment += `**æª¢æŸ¥æ™‚é–“**: ${(new Date()).toLocaleString('zh-TW')}\n`;
            comment += `**PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}\n`;
            comment += `**åˆ†æ”¯**: \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\n\n`;

            comment += `### ğŸ“Š æª¢æŸ¥çµæœ\n\n`;
            comment += `| æª¢æŸ¥é …ç›® | ç‹€æ…‹ |\n`;
            comment += `|---------|-----|\n`;
            comment += `| ğŸ—ï¸ ç¨‹å¼ç¢¼å“è³ª | ${cqStatus === 'success' ? 'âœ… é€šé' : cqStatus === 'skipped' ? 'â­ï¸ è·³é' : 'âŒ å¤±æ•—'} |\n`;
            comment += `| ğŸ”’ å®‰å…¨æ€§æƒæ | ${secStatus === 'success' ? 'âœ… é€šé' : secStatus === 'skipped' ? 'â­ï¸ è·³é' : 'âŒ å¤±æ•—'} |\n`;

            // å®‰å…¨æƒæè©³æƒ…
            comment += `\n### ğŸ”’ å®‰å…¨æ€§æƒæè©³æƒ…\n\n`;
            comment += `æœ¬æ¬¡ PR å·²é€šé CodeQL å®‰å…¨æƒæï¼Œæª¢æŸ¥ C# å’Œ JavaScript/TypeScript ç¨‹å¼ç¢¼çš„å®‰å…¨æ¼æ´ã€‚\n\n`;
            comment += `æŸ¥çœ‹è©³ç´°å®‰å…¨å ±å‘Šï¼š\n`;
            comment += `- å‰å¾€ [Security > Code scanning](../security/code-scanning) æŸ¥çœ‹å®Œæ•´æ¼æ´åˆ—è¡¨\n`;
            comment += `- ä¸‹è¼‰ SARIF å ±å‘Šå¾ [Actions artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            if (cqStatus !== 'success' || secStatus !== 'success') {
              comment += `\n### âš ï¸ éœ€è¦æ³¨æ„çš„å•é¡Œ\n\n`;
              if (cqStatus !== 'success') {
                comment += `- âŒ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å»ºç½®éŒ¯èª¤æˆ–æ ¼å¼å•é¡Œ\n`;
              }
              if (secStatus !== 'success') {
                comment += `- âŒ å®‰å…¨æ€§æƒæç™¼ç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ Security é é¢çš„è©³ç´°è³‡è¨Š\n`;
              }
              comment += `\nè«‹ä¿®æ­£ä¸Šè¿°å•é¡Œå¾Œé‡æ–°æ¨é€ç¨‹å¼ç¢¼ã€‚\n`;
            } else {
              comment += `\n### âœ… æ‰€æœ‰æª¢æŸ¥é€šé\n\n`;
              comment += `æ­å–œï¼æ‚¨çš„ PR å·²é€šéæ‰€æœ‰è‡ªå‹•æª¢æŸ¥ï¼Œå¯ä»¥é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥ã€‚\n`;
            }

            comment += `\n---\n`;
            comment += `ğŸ’¡ **æç¤º**: æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”Ÿæˆã€‚å¦‚éœ€æŸ¥çœ‹æ›´å¤šè©³æƒ…ï¼Œè«‹é»æ“Šä¸Šæ–¹çš„ [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) é€£çµã€‚\n`;

            // ç™¼å¸ƒç•™è¨€åˆ° PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
            });
        #ä»¥å…æ¬Šé™ä¸å¤ å°è‡´å¤±æ•—
        continue-on-error: true

      # ç™¼é€ Teams é€šçŸ¥
      - name: Notify Teams
        if: always()
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          workflow_name: ${{ github.workflow }}
          status: ${{ needs.code-quality.result }}
          title: 'PortalApi PR #${{ github.event.number }} å¯©æŸ¥å®Œæˆ'
          extra_info: |
            **PR æ¨™é¡Œ**: ${{ github.event.pull_request.title }}
            **åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}
            **ç¨‹å¼ç¢¼å“è³ª**: ${{ needs.code-quality.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
            **å®‰å…¨æ€§æƒæ**: ${{ needs.security-scan.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
            **PR é€£çµ**: ${{ github.event.pull_request.html_url }}
        continue-on-error: true
